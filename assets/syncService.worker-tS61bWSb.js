var hi=Object.defineProperty;var en=E=>{throw TypeError(E)};var mi=(E,O,k)=>O in E?hi(E,O,{enumerable:!0,configurable:!0,writable:!0,value:k}):E[O]=k;var $=(E,O,k)=>mi(E,typeof O!="symbol"?O+"":O,k),tn=(E,O,k)=>O.has(E)||en("Cannot "+k);var d=(E,O,k)=>(tn(E,O,"read from private field"),k?k.call(E):O.get(E)),S=(E,O,k)=>O.has(E)?en("Cannot add the same private member more than once"):O instanceof WeakSet?O.add(E):O.set(E,k),A=(E,O,k,me)=>(tn(E,O,"write to private field"),me?me.call(E,k):O.set(E,k),k);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var Ge,ee,de,v,Ce,Y,te,He,Qe,Me,Ye,Je,Xe,_e,re,oe,D,ne,Pe,ce,he;const E=Symbol("Comlink.proxy"),O=Symbol("Comlink.endpoint"),k=Symbol("Comlink.releaseProxy"),me=Symbol("Comlink.finalizer"),Ze=Symbol("Comlink.thrown"),zt=e=>typeof e=="object"&&e!==null||typeof e=="function",rn={canHandle:e=>zt(e)&&e[E],serialize(e){const{port1:t,port2:r}=new MessageChannel;return yt(e,t),[r,[r]]},deserialize(e){return e.start(),cn(e)}},nn={canHandle:e=>zt(e)&&Ze in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},Ut=new Map([["proxy",rn],["throw",nn]]);function sn(e,t){for(const r of e)if(t===r||r==="*"||r instanceof RegExp&&r.test(t))return!0;return!1}function yt(e,t=globalThis,r=["*"]){t.addEventListener("message",function n(s){if(!s||!s.data)return;if(!sn(r,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:c,path:o}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(ae);let a;try{const l=o.slice(0,-1).reduce((f,h)=>f[h],e),m=o.reduce((f,h)=>f[h],e);switch(c){case"GET":a=m;break;case"SET":l[o.slice(-1)[0]]=ae(s.data.value),a=!0;break;case"APPLY":a=m.apply(l,u);break;case"CONSTRUCT":{const f=new m(...u);a=dn(f)}break;case"ENDPOINT":{const{port1:f,port2:h}=new MessageChannel;yt(e,h),a=fn(f,[f])}break;case"RELEASE":a=void 0;break;default:return}}catch(l){a={value:l,[Ze]:0}}Promise.resolve(a).catch(l=>({value:l,[Ze]:0})).then(l=>{const[m,f]=nt(l);t.postMessage(Object.assign(Object.assign({},m),{id:i}),f),c==="RELEASE"&&(t.removeEventListener("message",n),Ft(t),me in e&&typeof e[me]=="function"&&e[me]())}).catch(l=>{const[m,f]=nt({value:new TypeError("Unserializable return value"),[Ze]:0});t.postMessage(Object.assign(Object.assign({},m),{id:i}),f)})}),t.start&&t.start()}function on(e){return e.constructor.name==="MessagePort"}function Ft(e){on(e)&&e.close()}function cn(e,t){const r=new Map;return e.addEventListener("message",function(s){const{data:i}=s;if(!i||!i.id)return;const c=r.get(i.id);if(c)try{c(i)}finally{r.delete(i.id)}}),bt(e,r,[],t)}function et(e){if(e)throw new Error("Proxy has been released and is not useable")}function Kt(e){return pe(e,new Map,{type:"RELEASE"}).then(()=>{Ft(e)})}const tt=new WeakMap,rt="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(tt.get(e)||0)-1;tt.set(e,t),t===0&&Kt(e)});function an(e,t){const r=(tt.get(t)||0)+1;tt.set(t,r),rt&&rt.register(e,t,e)}function un(e){rt&&rt.unregister(e)}function bt(e,t,r=[],n=function(){}){let s=!1;const i=new Proxy(n,{get(c,o){if(et(s),o===k)return()=>{un(i),Kt(e),t.clear(),s=!0};if(o==="then"){if(r.length===0)return{then:()=>i};const u=pe(e,t,{type:"GET",path:r.map(a=>a.toString())}).then(ae);return u.then.bind(u)}return bt(e,t,[...r,o])},set(c,o,u){et(s);const[a,l]=nt(u);return pe(e,t,{type:"SET",path:[...r,o].map(m=>m.toString()),value:a},l).then(ae)},apply(c,o,u){et(s);const a=r[r.length-1];if(a===O)return pe(e,t,{type:"ENDPOINT"}).then(ae);if(a==="bind")return bt(e,t,r.slice(0,-1));const[l,m]=Wt(u);return pe(e,t,{type:"APPLY",path:r.map(f=>f.toString()),argumentList:l},m).then(ae)},construct(c,o){et(s);const[u,a]=Wt(o);return pe(e,t,{type:"CONSTRUCT",path:r.map(l=>l.toString()),argumentList:u},a).then(ae)}});return an(i,e),i}function ln(e){return Array.prototype.concat.apply([],e)}function Wt(e){const t=e.map(nt);return[t.map(r=>r[0]),ln(t.map(r=>r[1]))]}const Gt=new WeakMap;function fn(e,t){return Gt.set(e,t),e}function dn(e){return Object.assign(e,{[E]:!0})}function nt(e){for(const[t,r]of Ut)if(r.canHandle(e)){const[n,s]=r.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},Gt.get(e)||[]]}function ae(e){switch(e.type){case"HANDLER":return Ut.get(e.name).deserialize(e.value);case"RAW":return e.value}}function pe(e,t,r,n){return new Promise(s=>{const i=hn();t.set(i,s),e.start&&e.start(),e.postMessage(Object.assign({id:i},r),n)})}function hn(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const mn="https://api.wanikani.com/v2";class pn{constructor(){$(this,"token",null);$(this,"requestTimestamps",[]);$(this,"MAX_REQUESTS",50);$(this,"TIME_WINDOW",6e4)}setToken(t){this.token=t}async throttle(){const t=Date.now();if(this.requestTimestamps=this.requestTimestamps.filter(r=>t-r<this.TIME_WINDOW),this.requestTimestamps.length>=this.MAX_REQUESTS){const r=this.requestTimestamps[0],n=this.TIME_WINDOW-(t-r)+500;if(n>0)return console.warn(`[WaniKaniService] Rate limit reached. Waiting ${Math.round(n)}ms...`),await new Promise(s=>setTimeout(s,n)),this.throttle()}this.requestTimestamps.push(Date.now())}async request(t,r){if(!this.token)throw new Error("API Token not set");await this.throttle();const n=t.startsWith("http")?t:`${mn}${t}`,s=await fetch(n,{...r,headers:{Authorization:`Bearer ${this.token}`,"Wanikani-Revision":"20170710","Content-Type":"application/json",...r==null?void 0:r.headers}});if(!s.ok){if(s.status===401)throw new Error("Invalid API Key");if(s.status===429)return console.warn("[WaniKaniService] Received 429. Backing off..."),await new Promise(i=>setTimeout(i,5e3)),this.request(t,r);throw new Error(`API Error: ${s.status} ${s.statusText}`)}return s.json()}async getUser(){return this.request("/user")}async getSummary(){return this.request("/summary")}async getSubjects(t){if(t.length===0)return{object:"collection",url:"",pages:{per_page:0,next_url:null,previous_url:null},total_count:0,data:[]};const r=t.join(",");return this.request(`/subjects?ids=${r}`)}async getLevelSubjects(t){return this.request(`/subjects?levels=${t.join(",")}`)}async getAssignments(t,r,n){const s=new URLSearchParams;return t&&t.length>0&&s.append("subject_ids",t.join(",")),r&&r.length>0&&s.append("levels",r.join(",")),n&&n.length>0&&s.append("srs_stages",n.join(",")),this.request(`/assignments?${s.toString()}`)}async getStudyMaterials(t){if(t.length===0)return{object:"collection",url:"",pages:{per_page:0,next_url:null,previous_url:null},total_count:0,data:[]};const r=new URLSearchParams;return r.append("subject_ids",t.join(",")),this.request(`/study_materials?${r.toString()}`)}async getSubjectsUpdatedAfter(t){const r=new URLSearchParams;return t&&r.append("updated_after",t),this.request(`/subjects?${r.toString()}`)}async getAssignmentsUpdatedAfter(t){const r=new URLSearchParams;return t&&r.append("updated_after",t),this.request(`/assignments?${r.toString()}`)}async getStudyMaterialsUpdatedAfter(t){const r=new URLSearchParams;return t&&r.append("updated_after",t),this.request(`/study_materials?${r.toString()}`)}async startAssignment(t){return this.request(`/assignments/${t}/start`,{method:"PUT"})}async createReview(t,r,n){return this.request("/reviews",{method:"POST",body:JSON.stringify({review:{assignment_id:t,incorrect_meaning_answers:r,incorrect_reading_answers:n}})})}}const ge=new pn;var Vt=function(e){return function(t,r,n){return e(t,r,n)*n}},wt=function(e,t){if(e)throw Error("Invalid sort config: "+t)},Bt=function(e){var t=e||{},r=t.asc,n=t.desc,s=r?1:-1,i=r||n;wt(!i,"Expected `asc` or `desc` property"),wt(r&&n,"Ambiguous object with `asc` and `desc` config properties");var c=e.comparer&&Vt(e.comparer);return{order:s,sortBy:i,comparer:c}},gn=function(e){return function t(r,n,s,i,c,o,u){var a,l;if(typeof r=="string")a=o[r],l=u[r];else if(typeof r=="function")a=r(o),l=r(u);else{var m=Bt(r);return t(m.sortBy,n,s,m.order,m.comparer||e,o,u)}var f=c(a,l,i);return(f===0||a==null&&l==null)&&n.length>s?t(n[s],n,s+1,i,c,o,u):f}};function Ht(e,t,r){if(e===void 0||e===!0)return function(i,c){return t(i,c,r)};if(typeof e=="string")return wt(e.includes("."),"String syntax not allowed for nested properties."),function(i,c){return t(i[e],c[e],r)};if(typeof e=="function")return function(i,c){return t(e(i),e(c),r)};if(Array.isArray(e)){var n=gn(t);return function(i,c){return n(e[0],e,1,r,t,i,c)}}var s=Bt(e);return Ht(s.sortBy,s.comparer||t,s.order)}var Et=function(e,t,r,n){var s;return Array.isArray(t)?(Array.isArray(r)&&r.length<2&&(s=r,r=s[0]),t.sort(Ht(r,n,e))):t};function Qt(e){var t=Vt(e.comparer);return function(r){var n=Array.isArray(r)&&!e.inPlaceSorting?r.slice():r;return{asc:function(s){return Et(1,n,s,t)},desc:function(s){return Et(-1,n,s,t)},by:function(s){return Et(1,n,s,t)}}}}var Yt=function(e,t,r){return e==null?r:t==null?-r:typeof e!=typeof t?typeof e<typeof t?-1:1:e<t?-1:e>t?1:0},$n=Qt({comparer:Yt});Qt({comparer:Yt,inPlaceSorting:!0});function st(e,t){const r=t.replaceAll(/\[(\w+)\]/g,".$1");if(r.includes("..")||r.startsWith(".")||r.endsWith("."))return;const n=r.split(".");let s=e;for(const i of n){if(s==null)return;s=s[i]}if(s!==void 0)return s}function yn(e,t){return $n(e).by(Object.entries(t).map(([r,n])=>({[n===1?"asc":"desc"]:i=>st(i,r)})))}function Jt(e,t,r,n=!1){if(e==null)return e;const s=t.split(/[.[\]]/g);s[0]===""&&s.shift(),s.at(-1)===""&&s.pop();const i=c=>{if(s.length>1){const o=s.shift(),u=!Number.isNaN(Number.parseInt(s[0],10));c[o]===void 0&&(c[o]=u?[]:{}),i(c[o])}else{if(n&&r===void 0){delete c[s[0]];return}c[s[0]]=r}};return i(e),e}function bn(e,t){if(Object.values(t).every(s=>s===0)){const s={...e};return Object.keys(t).forEach(i=>{st(e,i)!==void 0&&Jt(s,i,void 0,!0)}),s}const n={};return Object.entries(t).forEach(([s,i])=>{const c=st(e,s);c!==void 0&&(c==null&&i!==1||Jt(n,s,i===1?c:void 0))}),n}function Te(e,t){if(Object.is(e,t))return!0;if(e instanceof RegExp&&t instanceof RegExp)return e.toString()===t.toString();if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(typeof e!="object"||typeof t!="object"||e===null||t===null)return!1;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const s of r)if(!n.includes(s)||!Te(e[s],t[s]))return!1;return!0}function wn(e,t){const r=new Set;return e.filter(n=>{const s=typeof t=="function"?t(n):n[t];return!r.has(s)&&r.add(s)})}class En{constructor(t){$(this,"previousItems",[]);$(this,"callbacks");$(this,"unbindEvents");this.callbacks={added:[],addedBefore:[],changed:[],changedField:[],movedBefore:[],removed:[]},this.unbindEvents=t()}call(t,...r){this.callbacks[t].forEach(({callback:n,options:s})=>{(!s.skipInitial||!s.isInitial)&&n(...r)})}hasCallbacks(t){return t.some(r=>this.callbacks[r].length>0)}isEmpty(){return!this.hasCallbacks(["added","addedBefore","changed","changedField","movedBefore","removed"])}runChecks(t){const r=new Map(this.previousItems.map((s,i)=>[s.id,{item:s,index:i,beforeItem:this.previousItems[i+1]||null}])),n=new Map(t.map((s,i)=>[s.id,{item:s,index:i,beforeItem:t[i+1]||null}]));this.hasCallbacks(["changed","changedField","movedBefore","removed"])&&r.forEach(({item:s,index:i,beforeItem:c})=>{var u;const o=n.get(s.id);o?(this.hasCallbacks(["changed","changedField"])&&!Te(o.item,s)&&(this.call("changed",o.item),this.hasCallbacks(["changedField"])&&wn([...Object.keys(o.item),...Object.keys(s)],l=>l).forEach(l=>{Te(o.item[l],s[l])||this.call("changedField",o.item,l,s[l],o.item[l])})),o.index!==i&&((u=o.beforeItem)==null?void 0:u.id)!==(c==null?void 0:c.id)&&this.call("movedBefore",o.item,o.beforeItem)):this.call("removed",s)}),this.hasCallbacks(["added","addedBefore"])&&t.forEach((s,i)=>{r.get(s.id)||(this.call("added",s),this.call("addedBefore",s,t[i+1]||null))}),this.previousItems=t,Object.keys(this.callbacks).forEach(s=>{const i=s,c=this.callbacks[i];this.callbacks[i]=c.map(o=>({...o,options:{...o.options,isInitial:!1}}))})}stop(){this.unbindEvents()}addCallbacks(t,r=!1){Object.keys(t).forEach(n=>{const s=n;this.callbacks[s].push({callback:t[s],options:{skipInitial:r,isInitial:!0}})})}removeCallbacks(t){Object.keys(t).forEach(r=>{const n=r,s=this.callbacks[n].findIndex(({callback:i})=>i===t[n]);this.callbacks[n].splice(s,1)})}}function Xt(e){return e?e.isInScope?e.isInScope():!0:!1}let On=class{constructor(t,r){$(this,"observer");$(this,"getFilteredItems");$(this,"options");$(this,"onCleanupCallbacks",[]);this.getFilteredItems=t,this.options=r||{}}addGetters(t){if(!Xt(this.options.reactive))return t;const r=this.depend.bind(this);return Object.entries(t).reduce((n,[s,i])=>(Object.defineProperty(n,s,{get(){return r({changedField:c=>(o,u)=>{u!==s||o.id!==t.id||c()}}),i},enumerable:!0,configurable:!0}),n),{})}transform(t){const r=this.options.fieldTracking?this.addGetters(t):t;return this.options.transform?this.options.transform(r):r}getItems(){const t=this.getFilteredItems(),{sort:r,skip:n,limit:s}=this.options,i=r?yn(t,r):t,c=n?i.slice(n):i,o=s?c.slice(0,s):c,u=this.options.fields&&this.options.fields.id===0;return o.map(a=>this.options.fields?{...u?{}:{id:a.id},...bn(a,this.options.fields)}:a)}depend(t){if(!this.options.reactive||!Xt(this.options.reactive))return;const r=this.options.reactive.create();r.depend();const n=()=>r.notify();function s(c){const o=t[c];return(...u)=>{if(o===!0){n();return}typeof o=="function"&&o(n)(...u)}}const i=this.observeRawChanges({added:s("added"),addedBefore:s("addedBefore"),changed:s("changed"),changedField:s("changedField"),movedBefore:s("movedBefore"),removed:s("removed")},!0);this.options.reactive.onDispose&&this.options.reactive.onDispose(()=>i(),r),this.onCleanup(i)}ensureObserver(){if(!this.observer){const t=new En(()=>{const r=()=>{t.runChecks(this.getItems())},n=this.options.bindEvents&&this.options.bindEvents(r);return()=>{n&&n()}});this.onCleanup(()=>t.stop()),this.observer=t}return this.observer}observeRawChanges(t,r=!1){const n=this.ensureObserver();return n.addCallbacks(t,r),n.runChecks(this.getItems()),()=>{n.removeCallbacks(t),n.isEmpty()&&(n.stop(),this.observer=void 0)}}cleanup(){this.onCleanupCallbacks.forEach(t=>{t()}),this.onCleanupCallbacks=[]}onCleanup(t){this.onCleanupCallbacks.push(t)}forEach(t){const r=this.getItems();this.depend({addedBefore:!0,removed:!0,movedBefore:!0,...this.options.fieldTracking?{}:{changed:!0}}),r.forEach(n=>{t(this.transform(n))})}map(t){const r=[];return this.forEach(n=>{r.push(t(n))}),r}fetch(){return this.map(t=>t)}count(){const t=this.getItems();return this.depend({added:!0,removed:!0}),t.length}observeChanges(t,r=!1){return this.observeRawChanges(Object.entries(t).reduce((n,[s,i])=>i?{...n,[s]:(c,o)=>{const u=this.transform(c),a=o!==void 0,l=a&&o?this.transform(o):null;return i(u,...a?[l]:[])}}:n,{}),r)}requery(){this.observer&&this.observer.runChecks(this.getItems())}};class Sn{constructor(){$(this,"_maxListeners",100);$(this,"_listenerStore",new Map)}setMaxListeners(t){return this._maxListeners=t,this}on(t,r){let n=this._listenerStore.get(t);return n||(n=new Set,this._listenerStore.set(t,n)),n.add(r),n.size>this._maxListeners&&console.warn(`Possible EventEmitter memory leak detected. ${n.size} ${String(t)} listeners added. Use emitter.setMaxListeners() to increase limit.`),this}addListener(t,r){return this.on(t,r)}once(t,r){const n=((...s)=>{r(...s),this.off(t,n)});return this.on(t,n)}off(t,r){const n=this._listenerStore.get(t);return n?(n.delete(r),n.size===0&&this._listenerStore.delete(t),this):this}removeListener(t,r){return this.off(t,r)}emit(t,...r){this.listeners(t).forEach(n=>{n(...r)})}listeners(t){const r=this._listenerStore.get(t);return r?[...r.values()]:[]}listenerCount(t){const r=this._listenerStore.get(t);return r?r.size:0}removeAllListeners(t){if(t===void 0){for(const[r,n]of this._listenerStore.entries())for(const s of n.values())this.off(r,s);this._listenerStore.clear()}else{const r=this._listenerStore.get(t);if(r){for(const n of r.values())this.off(t,n);this._listenerStore.delete(t)}}return this}}class xn extends Error{}const Re=Symbol("missing"),Zt="mingo: cycle detected while processing object/array",it=e=>{const t=Oe(e);let r=0,n=t.length;for(;n;)r=(r<<5)-r^t.charCodeAt(--n);return r>>>0},$e=e=>typeof e!="object"&&typeof e!="function"||e===null,er=e=>$e(e)||X(e)||L(e),tr={undefined:1,null:2,number:3,string:4,symbol:5,object:6,array:7,arraybuffer:8,boolean:9,date:10,regexp:11,function:12};function Q(e,t){e===Re&&(e=void 0),t===Re&&(t=void 0);const r=100,[n,s]=[e,t].map(i=>tr[nr(i)?"arraybuffer":J(i)]??r);return n!==s?n-s:(n===r&&(e=Oe(e),t=Oe(t)),B(e,t)?0:e<t?-1:1)}const Lt=class Lt extends Map{constructor(){super();S(this,Ge,it);S(this,ee,new Map);S(this,de,r=>{const n=d(this,Ge).call(this,r);return[(d(this,ee).get(n)||[]).find(s=>B(s,r)),n]})}static init(r){const n=new Lt;return r&&A(n,Ge,r),n}clear(){super.clear(),d(this,ee).clear()}delete(r){if($e(r))return super.delete(r);const[n,s]=d(this,de).call(this,r);return super.delete(n)?(d(this,ee).set(s,d(this,ee).get(s).filter(i=>!B(i,n))),!0):!1}get(r){if($e(r))return super.get(r);const[n,s]=d(this,de).call(this,r);return super.get(n)}has(r){if($e(r))return super.has(r);const[n,s]=d(this,de).call(this,r);return super.has(n)}set(r,n){if($e(r))return super.set(r,n);const[s,i]=d(this,de).call(this,r);if(super.has(s))super.set(s,n);else{super.set(r,n);const c=d(this,ee).get(i)||[];c.push(r),d(this,ee).set(i,c)}return this}get size(){return super.size}};Ge=new WeakMap,ee=new WeakMap,de=new WeakMap;let ye=Lt;function b(e,t){if(!e)throw new xn(t)}function J(e){var n,s;if(e===null)return"null";const t=typeof e;if(t!=="object"&&t in tr)return t;if(p(e))return"array";if(X(e))return"date";if(L(e))return"regexp";const r=Object.prototype.toString.call(e);return r==="[object Object]"?((s=(n=e==null?void 0:e.constructor)==null?void 0:n.name)==null?void 0:s.toLowerCase())??"object":r.slice(8,-1).toLowerCase()}const be=e=>typeof e=="boolean",W=e=>typeof e=="string",In=e=>typeof e=="symbol",I=e=>!isNaN(e)&&typeof e=="number",p=Array.isArray,x=e=>J(e)==="object",rr=e=>!$e(e),X=e=>e instanceof Date,L=e=>e instanceof RegExp,Ot=e=>typeof e=="function",G=e=>e==null,ue=(e,t=!0)=>!!e||t&&e==="",St=e=>G(e)||W(e)&&!e||p(e)&&e.length===0||x(e)&&Object.keys(e).length===0,we=e=>p(e)?e:[e],V=(e,t)=>!!e&&Object.prototype.hasOwnProperty.call(e,t),nr=e=>typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e),Ee=(e,t)=>{if(G(e)||be(e)||I(e)||W(e))return e;if(X(e))return new Date(e);if(L(e))return new RegExp(e);if(nr(e)){const r=e.constructor;return new r(e)}if(t instanceof Set||(t=new Set),t.has(e))throw new Error(Zt);t.add(e);try{if(p(e)){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=Ee(e[n],t);return r}if(x(e)){const r={};for(const n of Object.keys(e))r[n]=Ee(e[n],t);return r}}finally{t.delete(e)}return e},sr=e=>e===Re;function xt(e,t){if(sr(e)||G(e))return t;if(sr(t)||G(t))return e;const r=J(e);if(r!==J(t))return t;if(p(e)&&p(t))for(let n=0;n<t.length;n++)n<e.length?e[n]=xt(e[n],t[n]):e.push(t[n]);else if(r==="object")for(const n of Object.keys(t))e[n]=xt(e[n],t[n]);return e}function ir(e,t=it){const r=[ye.init(t),ye.init(t)];if(e.length===0)return[];if(e.some(n=>n.length===0))return[];if(e.length===1)return[...e[0]];e[e.length-1].forEach(n=>r[0].set(n,!0));for(let n=e.length-2;n>-1;n--){if(e[n].forEach(s=>{r[0].has(s)&&r[1].set(s,!0)}),r[1].size===0)return[];r.reverse(),r[1].clear()}return Array.from(r[0].keys())}function or(e,t=1){const r=new Array;function n(s,i){for(let c=0,o=s.length;c<o;c++)p(s[c])&&(i>0||i<0)?n(s[c],Math.max(-1,i-1)):r.push(s[c])}return n(e,t),r}function vn(e){const t={};for(;e;){for(const r of Object.getOwnPropertyNames(e))r in t||(t[r]=e[r]);e=Object.getPrototypeOf(e)}return t}const cr=e=>e!=null&&e.toString!==Object.prototype.toString;function B(e,t){if(e===t||Object.is(e,t))return!0;if(e===null||t===null||typeof e!=typeof t||typeof e!="object")return!1;if(X(e))return X(t)&&+e==+t;if(L(e))return L(t)&&e.toString()===t.toString();const r=J(e);if(r!==J(t))return!1;switch(r){case"array":if(e.length!==t.length)return!1;for(let n=0,s=e.length;n<s;n++)if(!B(e[n],t[n]))return!1;return!0;case"object":{const n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!1;for(const i of n)if(!(i in t&&B(e[i],t[i])))return!1;return!0}default:return cr(e)&&e.toString()===t.toString()}}function An(e,t=it){const r=ye.init(t);return e.forEach(n=>r.set(n,!0)),Array.from(r.keys())}function Oe(e,t){if(e===null)return"null";if(e===void 0)return"undefined";if(W(e)||I(e)||be(e))return JSON.stringify(e);if(X(e))return e.toISOString();if(L(e)||In(e)||Ot(e))return e.toString();if(t instanceof Set||(t=new Set),t.has(e))throw new Error(Zt);try{if(t.add(e),p(e))return"["+e.map(n=>Oe(n,t)).join(",")+"]";if(x(e))return"{"+Object.keys(e).sort().map(s=>`${s}:${Oe(e[s],t)}`).join()+"}";const r=cr(e)?e.toString():Oe(vn(e),t);return J(e)+"("+r+")"}finally{t.delete(e)}}function kn(e,t,r=it){if(e.length<1)return new Map;const n=ye.init(r);for(let s=0;s<e.length;s++){const i=e[s],c=t(i,s)??null;let o=n.get(c);o?o.push(i):(o=[i],n.set(c,o))}return n}function It(e,t){return rr(e)?e[t]:void 0}function jn(e,t){if(t<1)return e;for(;t--&&e.length===1&&p(e[0]);)e=e[0];return e}function q(e,t,r){let n=0;function s(c,o){let u=c;for(let a=0;a<o.length;a++){const l=o[a];if(/^\d+$/.exec(l)===null&&p(u)){if(a===0&&n>0)break;n+=1;const f=o.slice(a);u=u.reduce((h,g)=>{const y=s(g,f);return y!==void 0&&h.push(y),h},[]);break}else u=It(u,l);if(u===void 0)break}return u}const i=er(e)?e:s(e,t.split("."));return p(i)&&(r!=null&&r.unwrapArray)?jn(i,n):i}function De(e,t,r){const n=t.indexOf("."),s=n==-1?t:t.substring(0,n),i=t.substring(n+1),c=n!=-1;if(p(e)){const a=/^\d+$/.test(s),l=a&&(r!=null&&r.preserveIndex)?[...e]:[];if(a){const m=parseInt(s);let f=It(e,m);c&&(f=De(f,i,r)),r!=null&&r.preserveIndex?l[m]=f:l.push(f)}else for(const m of e){const f=De(m,t,r);r!=null&&r.preserveMissing?l.push(f??Re):(f!=null||r!=null&&r.preserveIndex)&&l.push(f)}return l}const o=r!=null&&r.preserveKeys?{...e}:{};let u=It(e,s);if(c&&(u=De(u,i,r)),u!==void 0)return o[s]=u,o}function vt(e){if(p(e))for(let t=e.length-1;t>=0;t--)e[t]===Re?e.splice(t,1):vt(e[t]);else if(x(e))for(const t in e)V(e,t)&&vt(e[t])}const ar=/^\d+$/;function Ne(e,t,r,n){const s=t.split("."),i=s[0],c=s.slice(1).join(".");if(s.length===1)(x(e)||p(e)&&ar.test(i))&&r(e,i);else{n!=null&&n.buildGraph&&G(e[i])&&(e[i]={});const o=e[i];if(!o)return;const u=!!(s.length>1&&ar.test(s[1]));p(o)&&(n!=null&&n.descendArray)&&!u?o.forEach((a=>Ne(a,c,r,n))):Ne(o,c,r,n)}}function Cn(e,t,r){Ne(e,t,((n,s)=>{n[s]=Ot(r)?r(n[s]):r}),{buildGraph:!0})}function ur(e,t,r){Ne(e,t,((n,s)=>{p(n)?n.splice(parseInt(s),1):x(n)&&delete n[s]}),r)}const se=e=>e&&e[0]==="$"&&/^\$[a-zA-Z0-9_]+$/.test(e);function lr(e){if(er(e))return L(e)?{$regex:e}:{$eq:e};if(rr(e)){if(!Object.keys(e).some(se))return{$eq:e};if(V(e,"$regex")){const t={...e};return t.$regex=new RegExp(e.$regex,e.$options),delete t.$options,t}}return e}var At=(e=>(e[e.CLONE_OFF=0]="CLONE_OFF",e[e.CLONE_INPUT=1]="CLONE_INPUT",e[e.CLONE_OUTPUT=2]="CLONE_OUTPUT",e[e.CLONE_ALL=3]="CLONE_ALL",e))(At||{});const Ve=class Ve{constructor(t,r,n){S(this,v);S(this,Ce);S(this,Y);A(this,v,t),A(this,Y,{}),this.update(r,n)}static init(t,r,n){return t instanceof Ve?new Ve(d(t,v),null,d(t,Y)).update(d(t,Ce)??r,n):new Ve(t,r,n)}update(t,r){var n,s,i;return A(this,Ce,t),Object.assign(d(this,Y),{variables:{...(n=d(this,Y))==null?void 0:n.variables,...r==null?void 0:r.variables},groupId:(r==null?void 0:r.groupId)??((s=d(this,Y))==null?void 0:s.groupId),now:((i=d(this,Y))==null?void 0:i.now)??(r==null?void 0:r.now)??Date.now()}),this}getOptions(){return Object.freeze({...d(this,v),context:le.from(d(this,v).context)})}get root(){return d(this,Ce)}get local(){return d(this,Y)}get idKey(){return d(this,v).idKey}get collation(){var t;return(t=d(this,v))==null?void 0:t.collation}get processingMode(){var t;return((t=d(this,v))==null?void 0:t.processingMode)||0}get useStrictMode(){var t;return(t=d(this,v))==null?void 0:t.useStrictMode}get scriptEnabled(){var t;return(t=d(this,v))==null?void 0:t.scriptEnabled}get useGlobalContext(){var t;return(t=d(this,v))==null?void 0:t.useGlobalContext}get hashFunction(){var t;return(t=d(this,v))==null?void 0:t.hashFunction}get collectionResolver(){var t;return(t=d(this,v))==null?void 0:t.collectionResolver}get jsonSchemaValidator(){var t;return(t=d(this,v))==null?void 0:t.jsonSchemaValidator}get variables(){var t;return(t=d(this,v))==null?void 0:t.variables}get context(){var t;return(t=d(this,v))==null?void 0:t.context}};v=new WeakMap,Ce=new WeakMap,Y=new WeakMap;let Le=Ve;function fr(e){return e instanceof Le?e.getOptions():Object.freeze({idKey:"_id",scriptEnabled:!0,useStrictMode:!0,useGlobalContext:!0,processingMode:0,...e,context:le.from((e==null?void 0:e.context)??le.init())})}var qe=(e=>(e.ACCUMULATOR="accumulator",e.EXPRESSION="expression",e.PIPELINE="pipeline",e.PROJECTION="projection",e.QUERY="query",e.WINDOW="window",e))(qe||{});const Be=class Be{constructor(){S(this,te,new Map(Object.values(qe).map(t=>[t,{}])))}static init(t={}){const r=new Be;for(const[n,s]of Object.entries(t))d(r,te).has(n)&&s&&r.addOperators(n,s);return r}static from(t){return Be.init(t&&Object.fromEntries(d(t,te))||{})}static merge(t,r){const n=Be.from(t);for(const s of Object.values(qe))n.addOperators(s,d(r,te).get(s));return n}addOperators(t,r){return d(this,te).set(t,Object.assign({},r,d(this,te).get(t))),this}getOperator(t,r){return d(this,te).get(t)[r]??null}addAccumulatorOps(t){return this.addOperators("accumulator",t)}addExpressionOps(t){return this.addOperators("expression",t)}addQueryOps(t){return this.addOperators("query",t)}addPipelineOps(t){return this.addOperators("pipeline",t)}addProjectionOps(t){return this.addOperators("projection",t)}addWindowOps(t){return this.addOperators("window",t)}};te=new WeakMap;let le=Be;const P=le.init();P.addAccumulatorOps.bind(P),P.addExpressionOps.bind(P),P.addPipelineOps.bind(P),P.addProjectionOps.bind(P),P.addQueryOps.bind(P),P.addWindowOps.bind(P);function ot(e,t,r){if(!se(t))return null;const{context:n,useGlobalContext:s}=r||{},i=n?n.getOperator(e,t):null;return!i&&s?P.getOperator(e,t):i}function H(e,t,r,n){const s=Le.init(n,e);return r&&se(r)?dr(e,t,r,s):ct(e,t,s)}const Mn=["$$ROOT","$$CURRENT","$$REMOVE","$$NOW"];function ct(e,t,r){var n,s;if(W(t)&&t.length>0&&t[0]==="$"){if(_n.includes(t))return t;let i=r.root;const c=t.split(".");if(Mn.includes(c[0])){switch(c[0]){case"$$ROOT":break;case"$$CURRENT":i=e;break;case"$$REMOVE":i=void 0;break;case"$$NOW":i=new Date((n=r.local)==null?void 0:n.now);break}t=t.slice(c[0].length+1)}else if(c[0].slice(0,2)==="$$"){i=Object.assign({},r.variables,{this:e},(s=r==null?void 0:r.local)==null?void 0:s.variables);const o=c[0].slice(2);b(V(i,o),`Use of undefined variable: ${o}`),t=t.slice(2)}else t=t.slice(1);return t===""?i:q(i,t)}if(p(t))return t.map(i=>ct(e,i,r));if(x(t)){const i={},c=Object.entries(t);for(const[o,u]of c){if(se(o))return b(c.length==1,"expression must have single operator."),dr(e,u,o,r);i[o]=ct(e,u,r)}return i}return t}function dr(e,t,r,n){const s=ot("expression",r,n);if(s)return s(e,t,n);const i=ot("accumulator",r,n);return b(!!i,`accumulator '${r}' is not registered.`),p(e)||(e=ct(e,t,n),t=null),b(p(e),`arguments must resolve to array for ${r}.`),i(e,t,n)}const _n=["$$KEEP","$$PRUNE","$$DESCEND"];var hr=Object.freeze({__proto__:null,$and:(e,t,r)=>{const n=H(e,t,null,r);return ue(n,r.useStrictMode)&&n.every(s=>ue(s,r.useStrictMode))},$not:(e,t,r)=>{const n=we(t);return n.length==0?!1:(b(n.length==1,"Expression $not takes exactly 1 argument"),!H(e,n[0],null,r))},$or:(e,t,r)=>{const n=H(e,t,null,r),s=r.useStrictMode;return ue(n,s)&&n.some(i=>ue(i,s))}});const Pn=(e,t,r)=>{const n=H(e,t,null,r);return b(p(n)&&n.length==2,"$cmp: expression must resolve to array of size 2."),Q(n[0],n[1])};function ze(e){return e instanceof mr?e:new mr(e)}function Tn(...e){let t=0;return ze(()=>{for(;t<e.length;){const r=e[t].next();if(!r.done)return r;t++}return{done:!0}})}function Rn(e){return!!e&&typeof e=="object"&&typeof(e==null?void 0:e.next)=="function"}function Dn(e){return!!e&&(typeof e=="object"||typeof e=="function")&&typeof e[Symbol.iterator]=="function"}class mr{constructor(t){S(this,He,[]);S(this,Qe,[]);S(this,Me);S(this,Ye,!1);const r=Dn(t)?t[Symbol.iterator]():Rn(t)?t:typeof t=="function"?{next:t}:null;b(!!r,"Iterator must be initialized with an iterable or function.");let n=-1,s={done:!1};A(this,Me,()=>{for(;!s.done&&(s=r.next(),!s.done);){let i=s.value;if(n++,d(this,He).every(({op:o,fn:u})=>{const a=u(i,n);return o==="map"?!!(i=a)||!0:a}))return{value:i,done:!1}}return{done:!0}})}push(t,r){return d(this,He).push({op:t,fn:r}),this}next(){return d(this,Me).call(this)}map(t){return this.push("map",t)}filter(t){return this.push("filter",t)}take(t){return t>0?this.filter(r=>!(t===0||t--===0)):this}drop(t){return t>0?this.filter(r=>t===0||t--===0):this}transform(t){const r=this;let n;return ze(()=>(n||(n=ze(t(r.value()))),n.next()))}value(){for(;!d(this,Ye);){const{done:t,value:r}=d(this,Me).call(this);t||d(this,Qe).push(r),A(this,Ye,t)}return d(this,Qe)}each(t){for(;;){const r=this.next();if(r.done)break;if(t(r.value)===!1)return!1}return!0}reduce(t,r){let n=this.next();for(r===void 0&&!n.done&&(r=n.value,n=this.next());!n.done;)r=t(r,n.value),n=this.next();return r}size(){return this.reduce(((t,r)=>++t),0)}[Symbol.iterator](){return this}}He=new WeakMap,Qe=new WeakMap,Me=new WeakMap,Ye=new WeakMap;const Nn=(e,t,r)=>e.take(t),Ln=(e,t,r)=>St(t)?e:(gr(t,r),e.map(pr(t,Le.init(r))));function pr(e,t,r=!0){const n=t.idKey,s=Object.keys(e),i=new Array,c=new Array,o={};for(const f of s){const h=e[f];if(I(h)||be(h))h?c.push(f):i.push(f);else if(p(h))o[f]=g=>h.map(y=>H(g,y,null,t.update(g))??null);else if(x(h)){const g=Object.keys(h),y=g.length==1?g[0]:"",M=ot(qe.PROJECTION,y,t);M?y==="$slice"&&!we(h[y]).every(I)?o[f]=K=>H(K,h,f,t.update(K)):o[f]=K=>M(K,h[y],f,t.update(K)):se(y)?o[f]=N=>H(N,h[y],y,t):(gr(h,t),b(g.length>0,`Invalid empty sub-projection: ${f}`),o[f]=N=>{r&&t.update(N);const K=q(N,f),qt=pr(h,t,!1);if(p(K))return K.map(qt);if(x(K))return qt(K);const $t=qt(N);return V(N,f)||!x($t)||Object.keys($t).length?$t:void 0})}else o[f]=W(h)&&h[0]==="$"?g=>H(g,h,f,t):g=>h}const u=Object.keys(o),a=i.includes(n),l=r&&!a&&!c.includes(n),m={preserveMissing:!0};return f=>{const h={};for(const g of c){const y=De(f,g,m)??{};xt(h,y)}c.length&&vt(h);for(const g of u){const y=o[g](f);y===void 0?ur(h,g,{descendArray:!0}):Cn(h,g,y)}i.length===1&&a?Object.keys(h).length===0&&Object.assign(h,f):i.length&&Object.assign(h,{...f,...h});for(const g of i)ur(h,g,{descendArray:!0});return l&&V(f,n)&&(h[n]=q(f,n)),h}}function gr(e,t){let r=!1,n=!1;for(const[s,i]of Object.entries(e))b(!s.startsWith("$"),"Field names may not start with '$'."),b(!s.endsWith(".$"),"Positional projection operator '$' is not supported."),s!==(t==null?void 0:t.idKey)&&(i===0||i===!1?r=!0:(i===1||i===!0)&&(n=!0),b(!(r&&n),"Projection cannot have a mix of inclusion and exclusion."))}const qn=(e,t,r)=>e.drop(t),zn=(e,t,r)=>{if(St(t)||!x(t))return e;let n=Q;const s=r.collation;return x(s)&&W(s.locale)&&(n=Fn(s)),e.transform(i=>{const c=Object.keys(t);for(const o of c.reverse()){const u=kn(i,m=>q(m,o),r.hashFunction),a=Array.from(u.keys()).sort(n);t[o]===-1&&a.reverse();let l=0;for(const m of a)for(const f of u.get(m))i[l++]=f;b(l==i.length,"bug: counter must match collection size.")}return i})},Un={1:"base",2:"accent",3:"variant"};function Fn(e){const t={sensitivity:Un[e.strength||3],caseFirst:e.caseFirst==="off"?"false":e.caseFirst||"false",numeric:e.numericOrdering||!1,ignorePunctuation:e.alternate==="shifted"};e.caseLevel===!0&&(t.sensitivity==="base"&&(t.sensitivity="case"),t.sensitivity==="accent"&&(t.sensitivity="variant"));const r=new Intl.Collator(e.locale,t);return(n,s)=>{if(!W(n)||!W(s))return Q(n,s);const i=r.compare(n,s);return i<0?-1:i>0?1:0}}const Kn={$sort:zn,$skip:qn,$limit:Nn};class Wn{constructor(t,r,n,s){S(this,Je);S(this,Xe);S(this,_e);S(this,re);S(this,oe,{});S(this,D,null);S(this,ne,[]);A(this,Je,t),A(this,Xe,r),A(this,_e,n),A(this,re,s)}fetch(){if(d(this,D))return d(this,D);A(this,D,ze(d(this,Je)).filter(d(this,Xe)));const t=d(this,re).processingMode;t&At.CLONE_INPUT&&d(this,D).map(Ee);for(const r of["$sort","$skip","$limit"])V(d(this,oe),r)&&A(this,D,Kn[r](d(this,D),d(this,oe)[r],d(this,re)));return Object.keys(d(this,_e)).length&&A(this,D,Ln(d(this,D),d(this,_e),d(this,re))),t&At.CLONE_OUTPUT&&d(this,D).map(Ee),d(this,D)}fetchAll(){const t=ze([...d(this,ne)]);return d(this,ne).length=0,Tn(t,this.fetch())}all(){return this.fetchAll().value()}count(){return this.all().length}skip(t){return d(this,oe).$skip=t,this}limit(t){return d(this,oe).$limit=t,this}sort(t){return d(this,oe).$sort=t,this}collation(t){return A(this,re,{...d(this,re),collation:t}),this}next(){if(d(this,ne).length>0)return d(this,ne).pop();const t=this.fetch().next();if(!t.done)return t.value}hasNext(){if(d(this,ne).length>0)return!0;const t=this.fetch().next();return t.done?!1:(d(this,ne).push(t.value),!0)}map(t){return this.all().map(t)}forEach(t){this.all().forEach(t)}[Symbol.iterator](){return this.fetchAll()}}Je=new WeakMap,Xe=new WeakMap,_e=new WeakMap,re=new WeakMap,oe=new WeakMap,D=new WeakMap,ne=new WeakMap;const Gn=/^\$(and|or|nor|expr|jsonSchema)$/;class Se{constructor(t,r){S(this,Pe);S(this,ce);S(this,he);A(this,he,Ee(t)),A(this,ce,r),A(this,Pe,[]),this.compile()}compile(){b(x(d(this,he)),`query criteria must be an object: ${JSON.stringify(d(this,he))}`);const t={};for(const[r,n]of Object.entries(d(this,he))){if(r==="$where")b(d(this,ce).scriptEnabled,"$where operator requires 'scriptEnabled' option to be true."),Object.assign(t,{field:r,expr:n});else if(Gn.test(r))this.processOperator(r,r,n);else{b(!se(r),`unknown top level operator: ${r}`);for(const[s,i]of Object.entries(lr(n)))this.processOperator(r,s,i)}t.field&&this.processOperator(t.field,t.field,t.expr)}}processOperator(t,r,n){const s=ot(qe.QUERY,r,d(this,ce));b(!!s,`unknown query operator ${r}`),d(this,Pe).push(s(t,n,d(this,ce)))}test(t){return d(this,Pe).every(r=>r(t))}find(t,r){return new Wn(t,n=>this.test(n),r||{},d(this,ce))}}Pe=new WeakMap,ce=new WeakMap,he=new WeakMap;function j(e,t,r,n){const s={unwrapArray:!0},i=Math.max(1,e.split(".").length-1);return c=>{const o=q(c,e,s);return n(o,t,{...r,depth:i})}}function xe(e,t,r,n){const s=H(e,t,null,r);return n(...s)}function kt(e,t,r){return B(e,t)||G(e)&&G(t)?!0:p(e)?e.some(n=>B(n,t))||or(e,r==null?void 0:r.depth).some(n=>B(n,t)):!1}function $r(e,t,r){return!kt(e,t,r)}function yr(e,t,r){return G(e)?t.some(n=>n===null):ir([we(e),t],r==null?void 0:r.hashFunction).length>0}function Vn(e,t,r){return!yr(e,t,r)}function br(e,t,r){return at(e,t,(n,s)=>Q(n,s)<0)}function wr(e,t,r){return at(e,t,(n,s)=>Q(n,s)<=0)}function Er(e,t,r){return at(e,t,(n,s)=>Q(n,s)>0)}function Or(e,t,r){return at(e,t,(n,s)=>Q(n,s)>=0)}function Bn(e,t,r){return we(e).some((n=>t.length===2&&n%t[0]===t[1]))}function Hn(e,t,r){const n=we(e),s=i=>W(i)&&ue(t.exec(i),r==null?void 0:r.useStrictMode);return n.some(s)||or(n,1).some(s)}function Qn(e,t,r){if(!p(e)||!p(t)||!e.length||!t.length)return!1;let n=!0;for(const s of t){if(!n)break;x(s)&&Object.keys(s).includes("$elemMatch")?n=Sr(e,s.$elemMatch,r):L(s)?n=e.some(i=>typeof i=="string"&&s.test(i)):n=e.some(i=>B(s,i))}return n}function Yn(e,t,r){return Array.isArray(e)&&e.length===t}function Jn(e){return se(e)&&["$and","$or","$nor"].indexOf(e)===-1}function Sr(e,t,r){if(p(e)&&!St(e)){let n=c=>c,s=t;Object.keys(t).every(Jn)&&(s={temp:t},n=c=>({temp:c}));const i=new Se(s,r);for(let c=0,o=e.length;c<o;c++)if(i.test(n(e[c])))return!0}return!1}const xr=e=>e===null,Xn={array:p,boolean:be,bool:be,date:X,number:I,int:I,long:I,double:I,decimal:I,null:xr,object:x,regexp:L,regex:L,string:W,undefined:G,1:I,2:W,3:x,4:p,6:G,8:be,9:X,10:xr,11:L,16:I,18:I,19:I};function Ir(e,t,r){const n=Xn[t];return n?n(e):!1}function Zn(e,t,r){return p(t)?t.findIndex(n=>Ir(e,n))>=0:Ir(e,t)}function at(e,t,r){return we(e).some(n=>J(n)===J(t)&&r(n,t))}var vr=Object.freeze({__proto__:null,$cmp:Pn,$eq:(e,t,r)=>xe(e,t,r,kt),$gt:(e,t,r)=>xe(e,t,r,Er),$gte:(e,t,r)=>xe(e,t,r,Or),$lt:(e,t,r)=>xe(e,t,r,br),$lte:(e,t,r)=>xe(e,t,r,wr),$ne:(e,t,r)=>xe(e,t,r,$r)});const es=(e,t,r,n)=>{const s=q(e,r),i=new Se(t,n);b(p(s),"$elemMatch: argument must resolve to array");const c=[];for(let o=0;o<s.length;o++)if(i.test(s[o])){if(n.useStrictMode)return[s[o]];c.push(s[o])}return c.length>0?c:void 0},ts=(e,t,r)=>{const n=H(e,t,null,r),s=n[0];let i=n[1],c=n[2];return G(c)?i<0?i=Math.max(0,s.length+i):(c=i,i=0):(i<0&&(i=Math.max(0,s.length+i)),b(c>0,"Invalid argument for $slice operator. Limit must be a positive number"),c+=i),s.slice(i,c)};var rs=Object.freeze({__proto__:null,$elemMatch:es,$slice:(e,t,r,n)=>{const s=q(e,r),i=t;return p(s)?ts(e,p(t)?[s,...i]:[s,t],n):s}});const ns=(e,t,r)=>j(e,t,r,Qn),ss=(e,t,r)=>j(e,t,r,Sr),is=(e,t,r)=>j(e,t,r,Yn),ut=(e,t,r)=>j(e,t,null,(n,s)=>{let i=0;if(p(s))for(const c of s)i=i|1<<c;else i=s;return r(n&i,i)}),os=(e,t,r)=>ut(e,t,(n,s)=>n==0),cs=(e,t,r)=>ut(e,t,(n,s)=>n==s),as=(e,t,r)=>ut(e,t,(n,s)=>n<s),us=(e,t,r)=>ut(e,t,(n,s)=>n>0),ls=(e,t,r)=>j(e,t,r,kt),fs=(e,t,r)=>j(e,t,r,Er),ds=(e,t,r)=>j(e,t,r,Or),hs=(e,t,r)=>j(e,t,r,yr),ms=(e,t,r)=>j(e,t,r,br),ps=(e,t,r)=>j(e,t,r,wr),gs=(e,t,r)=>j(e,t,r,$r),$s=(e,t,r)=>j(e,t,r,Vn),ys=(e,t,r)=>{const n=e.includes("."),s=!!t;return!n||e.match(/\.\d+$/)?i=>q(i,e)!==void 0===s:i=>{const c=De(i,e,{preserveIndex:!0}),o=q(c,e.substring(0,e.lastIndexOf(".")));return p(o)?o.some(u=>u!==void 0)===s:o!==void 0===s}},bs=(e,t,r)=>j(e,t,r,Zn);function ws(e,t,r){return n=>ue(H(n,t,null,r),r.useStrictMode)}function Es(e,t,r){b(!!(r!=null&&r.jsonSchemaValidator),"$jsonSchema: must configure 'jsonSchemaValidator' option to this operator.");const n=r==null?void 0:r.jsonSchemaValidator(t);return s=>n(s)}const Os=(e,t,r)=>j(e,t,r,Bn),Ss=(e,t,r)=>j(e,t,r,Hn);function xs(e,t,r){b(r.scriptEnabled,"$where: 'scriptEnabled' option must be true");const n=t;return b(Ot(n),"$where only accepts a Function object"),s=>ue(n.call(s),r==null?void 0:r.useStrictMode)}const Is=(e,t,r)=>{b(p(t),"Invalid expression: $and expects value to be an Array.");const n=t.map(s=>new Se(s,r));return s=>n.every(i=>i.test(s))},Ar=(e,t,r)=>{b(p(t),"Invalid expression. $or expects value to be an Array");const n=t.map(s=>new Se(s,r));return s=>n.some(i=>i.test(s))};var kr=Object.freeze({__proto__:null,$all:ns,$and:Is,$bitsAllClear:os,$bitsAllSet:cs,$bitsAnyClear:as,$bitsAnySet:us,$elemMatch:ss,$eq:ls,$exists:ys,$expr:ws,$gt:fs,$gte:ds,$in:hs,$jsonSchema:Es,$lt:ms,$lte:ps,$mod:Os,$ne:gs,$nin:$s,$nor:(e,t,r)=>{b(p(t),"Invalid expression. $nor expects value to be an array.");const n=Ar("$or",t,r);return s=>!n(s)},$not:(e,t,r)=>{const n={};n[e]=lr(t);const s=new Se(n,r);return i=>!s.test(i)},$or:Ar,$regex:Ss,$size:is,$type:bs,$where:xs});class lt extends Se{constructor(t,r){const n=fr(r);n.context.addExpressionOps(hr).addExpressionOps(vr).addProjectionOps(rs).addQueryOps(kr),super(t,n)}}const C={cloneMode:"copy",queryOptions:fr({context:le.init().addQueryOps(kr).addExpressionOps(hr).addExpressionOps(vr)})},jt=(e,t)=>{switch(e){case"deep":return Ee(t);case"copy":return X(t)?new Date(t):p(t)?[...t]:x(t)?{...t}:L(t)?new RegExp(t):t;default:return t}},vs=/^[a-z]+[a-zA-Z0-9]*$/;function jr(e){if(!e.includes(".$"))return[{parent:e,selector:e},[]];const t=e.indexOf(".$"),r=e.indexOf("]"),n=e.substring(0,t),s=e.substring(t+3,r);b(s===""||vs.test(s),"The filter <identifier> must begin with a lowercase letter and contain only alphanumeric characters.");const i=e.substring(r+2),[c,o]=i?jr(i):[];return[{selector:e,parent:n,child:s||"$",next:c},[s,...o||[]].filter(Boolean)]}const _=(e,t,r,n,s)=>{const{parent:i,child:c,next:o}=t;if(!c){let a=!1;return Ne(e,i,(m,f)=>a=!!n(m,f)||a,s),a}const u=q(e,i);return p(u)?u.map((a,l)=>r[c]&&!r[c].test({[c]:a})?!1:o?_(a,o,r,n,s):n(u,l)).some(Boolean):!1};function T(e,t,r,n){const s=[];for(const[i,c]of Object.entries(e)){const[o,u]=jr(i);if(!u.length)n(c,o,{})&&s.push(o.parent);else{const a={};t.forEach(m=>{Object.keys(m).forEach(f=>{u.forEach(h=>{(f===h||f.startsWith(h+"."))&&(a[h]=a[h]||{},Object.assign(a[h],{[f]:m[f]}))})})});const l={};for(const[m,f]of Object.entries(a))l[m]=new lt(f,r.queryOptions);n(c,o,l)&&s.push(o.parent)}}return s}const As=(e,t,r=[],n=C)=>T(t,r,n,(s,i,c)=>{const o={$each:[s]};return x(s)&&V(s,"$each")&&Object.assign(o,s),_(e,i,c,(u,a)=>{const l=u[a]||(u[a]=[]);return ir([l,o.$each]).length===o.$each.length?!1:(u[a]=jt(n.cloneMode,An(l.concat(o.$each))),!0)},{buildGraph:!0})}),ks=new Set(["and","or","xor"]),js=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>{const o=Object.keys(s);return b(o.length===1&&ks.has(o[0]),`Invalid bit operator '${o[0]}'. Must be one of 'and', 'or', or 'xor'.`),_(e,i,c,(u,a)=>{let l=u[a];const m=s[o[0]];if(l!==void 0&&!(I(l)&&I(m)))return!1;switch(l=l||0,o[0]){case"and":u[a]=l&m;break;case"or":u[a]=l|m;break;case"xor":u[a]=l^m;break}return u[a]!==l},{buildGraph:!0})})),Cs=(e,t,r=[],n=C)=>{const s=Date.now();return T(t,r,n,((i,c,o)=>_(e,c,o,(u,a)=>(u[a]=s,!0),{buildGraph:!0})))},Ms=(e,t,r=[],n=C)=>T(t,r,n,(s,i,c)=>{if(!i.child){const o=q(e,i.parent);b(o===void 0||I(o),"cannot apply $inc to a value of non-numeric type")}return _(e,i,c,(o,u)=>(o[u]=(o[u]||(o[u]=0))+s,!0),{buildGraph:!0})}),_s=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>_(e,i,c,(o,u)=>o[u]!==void 0&&Q(o[u],s)>-1?!1:(o[u]=s,!0),{buildGraph:!0}))),Ps=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>_(e,i,c,(o,u)=>o[u]!==void 0&&Q(o[u],s)<1?!1:(o[u]=s,!0),{buildGraph:!0}))),Ts=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>_(e,i,c,(o,u)=>{const a=o[u];return o[u]=o[u]===void 0?0:o[u]*s,o[u]!==a},{buildGraph:!0}))),Rs=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>_(e,i,c,(o,u)=>{const a=o[u];return b(p(a),`path '${i.selector}' contains an element of non-array type.`),a.length?(s===-1?a.splice(0,1):a.pop(),!0):!1}))),Cr=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>{const o=!x(s)||Object.keys(s).some(se),u=new lt(o?{k:s}:s,n.queryOptions),a=o?l=>u.test({k:l}):l=>u.test(l);return _(e,i,c,(l,m)=>{const f=l[m],h=new Array;return f.map(y=>{const M=a(y);return M||h.push(y),M}).some(Boolean)?(l[m]=h,!0):!1})})),Ds=(e,t,r=[],n=C)=>{const s={};return Object.entries(t).forEach(([i,c])=>{s[i]={$in:c}}),Cr(e,s,r,n)},Ns=["$each","$slice","$sort","$position"],Ls=(e,t,r=[],n=C)=>T(t,r,n,((s,i,c)=>{const o={$each:[s]};return x(s)&&Ns.some(u=>V(s,u))&&Object.assign(o,s),_(e,i,c,(u,a)=>{const l=u[a]||(u[a]=[]),m=l.slice(0,o.$slice||l.length),f=l.length,h=I(o.$position)?o.$position:l.length;if(l.splice(h,0,...jt(n.cloneMode,o.$each)),o.$sort){const g=x(o.$sort)?Object.keys(o.$sort||{}).pop():"",y=g?o.$sort[g]:o.$sort,M=g?N=>q(N,g):N=>N;l.sort((N,K)=>y*Q(M(N),M(K)))}return I(o.$slice)&&(o.$slice<0?l.splice(0,l.length+o.$slice):l.splice(o.$slice)),f!=l.length||!B(m,l)},{descendArray:!0,buildGraph:!0})})),Mr=(e,t,r=[],n=C)=>T(t,r,n,(s,i,c)=>_(e,i,c,(o,u)=>B(o[u],s)?!1:(o[u]=jt(n.cloneMode,s),!0),{buildGraph:!0}));var _r=Object.freeze({__proto__:null,$addToSet:As,$bit:js,$currentDate:Cs,$inc:Ms,$max:_s,$min:Ps,$mul:Ts,$pop:Rs,$pull:Cr,$pullAll:Ds,$push:Ls,$rename:(e,t,r=[],n=C)=>{const s=[],i=T(t,r,n,((c,o,u)=>_(e,o,u,(a,l)=>V(a,l)?(s.push(...Mr(e,{[c]:a[l]},r,n)),delete a[l],!0):!1)));return Array.from(new Set(i.concat(s)))},$set:Mr,$unset:(e,t,r=[],n=C)=>T(t,r,n,(s,i,c)=>_(e,i,c,(o,u)=>V(o,u)?(p(o)?o[u]=null:delete o[u],!0):!1))});function qs(e){return e=e??C,(t,r,n=[],s={},i=e)=>{const c=Object.entries(r);b(c.length===1,"Update expression must contain only one operator.");const[o,u]=c[0];b(V(_r,o),`Update operator '${o}' is not supported.`);const a=_r[o];return Object.keys(s).length&&!new lt(s,i.queryOptions).test(t)?[]:a(t,u,n,i)}}const zs=qs();function Pr(e,t){return new lt(t).test(e)}function Ue(e){if(typeof e=="function")throw new Error("Cloning functions is not supported");if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return e.map(r=>Ue(r));if(e instanceof Map){const r=new Map;return e.forEach((n,s)=>{r.set(s,Ue(n))}),r}if(e instanceof Set){const r=new Set;return e.forEach(n=>{r.add(Ue(n))}),r}if(e instanceof RegExp)return new RegExp(e);const t={};for(const r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=Ue(e[r]));return t}function Ct(e){if(typeof structuredClone=="function")return structuredClone(e);/* istanbul ignore next -- @preserve */return Ue(e)}function ft(e,t){if(!Object.keys(t).some(s=>s.startsWith("$")))return t;const n=Ct(e);return zs(n,t),n}function Tr(){return Math.floor(Math.random()*1e17).toString(16)}function z(e){return e==null?null:typeof e=="string"?e:typeof e=="number"||typeof e=="boolean"?e.toString():e instanceof Date?e.toISOString():JSON.stringify(e)}function Rr(e,t,r=Object.is){let n=t;const s=e==null?void 0:e.create(),i=()=>e!=null&&e.isInScope?e.isInScope():!0;return{get(){return s&&i()&&s.depend(),n},set(o){r(n,o)||(n=o,s&&s.notify())}}}function Dr(...e){return e.length===0?[]:[...new Set(e.reduce((t,r)=>t.filter(n=>r.includes(n))))]}function Us(e,t){return e.reduce((r,n)=>{const s=n.query(t);if(!s.matched)return r;const i=s.keepSelector?r.optimizedSelector:Object.fromEntries(Object.entries(r.optimizedSelector).filter(([c])=>!s.fields.includes(c)));return{matched:!0,positions:[...new Set(r.matched?Dr(r.positions,s.positions):s.positions)],optimizedSelector:i}},{matched:!1,positions:[],optimizedSelector:{...t}})}function Mt(e,t){if(t==null||Object.keys(t).length<=0)return{matched:!1,positions:[],optimizedSelector:t};const{$and:r,$or:n,...s}=t,i=Us(e,s);let{matched:c,positions:o}=i;const u=i.optimizedSelector;if(Array.isArray(r)){const a=[];for(const l of r){const{matched:m,positions:f,optimizedSelector:h}=Mt(e,l);m?(o=c?Dr(o,f):f,c=!0,Object.keys(h).length>0&&a.push(h)):a.push(l)}a.length>0&&(u.$and=a)}if(Array.isArray(n)){const a=[],l=c,m=o;let f=!1;for(const h of n){const{matched:g,positions:y,optimizedSelector:M}=Mt(e,h);g?(o=[...new Set([...o,...y])],c=!0,Object.keys(M).length>0&&a.push(M)):(a.push(h),f=!0)}a.length>0&&(u.$or=a),f&&(u.$or=n,c=l,o=m)}return{matched:c,positions:o||[],optimizedSelector:u}}function ji(e){return e}const Nr=new Set(["$eq","$gt","$gte","$lt","$lte","$in","$nin","$ne","$exists","$not","$expr","$jsonSchema","$mod","$regex","$options","$text","$where","$all","$elemMatch","$size","$bitsAllClear","$bitsAllSet","$bitsAnyClear","$bitsAnySet"]);function Fs(e){if(typeof e!="object"||e==null)return!1;const t=Object.keys(e);return t.length===0||t.some(s=>!Nr.has(s))?!1:t.every(s=>Nr.has(s))}function Ks(e,t){const r={include:null,exclude:null},n=t[e];return n instanceof RegExp||n==null?r:Fs(n)?n.$ne!=null?(r.exclude=[z(n.$ne)],r):Array.isArray(n.$in)&&n.$in.length>0?(r.include=n.$in.map(z),r):Array.isArray(n.$nin)&&n.$nin.length>0?(r.exclude=n.$nin.map(z),r):{include:null,exclude:null}:(r.include=[z(n)],r)}function Lr(e,t){return{query(r){if(!Object.hasOwnProperty.call(r,e))return{matched:!1};const n=r[e],s=n==null||n.$exists===!1,i=s?{include:null,exclude:[...t.keys()].filter(o=>o!=null)}:Ks(e,r);if(i.include==null&&i.exclude==null)return{matched:!1};let c=[];if(i.include==null)for(const o of t.values())for(const u of o)c.push(u);else for(const o of i.include){const u=t.get(o);if(u)for(const a of u)c.push(a)}if(i.exclude!=null){const o=new Set;for(const u of i.exclude){const a=t.get(u);if(a)for(const l of a)o.add(l)}c=c.filter(u=>!o.has(u))}return{matched:!0,positions:c,fields:[e],keepSelector:s}},rebuild(){}}}function U(e){const t=new Map;return{...Lr(e,t),rebuild(r){t.clear(),r.forEach((n,s)=>{const i=z(st(n,e)),c=t.get(i)||new Set;c.add(s),t.set(i,c)})}}}function qr(e){return e.added.length>0||e.modified.length>0||e.removed.length>0}function Ws(e,{added:t,modified:r,removed:n}){const s=[...e];return t.forEach(i=>{s.push(i)}),r.forEach(i=>{const c=s.findIndex(({id:o})=>o===i.id);c!==-1&&(s[c]=i)}),n.forEach(i=>{const c=s.findIndex(({id:o})=>o===i.id);c!==-1&&s.splice(c,1)}),s}const w=class w extends Sn{constructor(r){super();$(this,"name");$(this,"options");$(this,"persistenceAdapter",null);$(this,"isPullingSignal");$(this,"isPushingSignal");$(this,"indexProviders",[]);$(this,"indicesOutdated",!1);$(this,"idIndex",new Map);$(this,"debugMode");$(this,"batchOperationInProgress",!1);$(this,"isDisposed",!1);$(this,"postBatchCallbacks",new Set);$(this,"fieldTracking",!1);$(this,"persistenceReadyPromise");if(w.collections.push(this),this.name=(r==null?void 0:r.name)??`${this.constructor.name}-${Tr()}`,this.options={memory:[],...r},this.fieldTracking=this.options.fieldTracking??w.fieldTracking,this.debugMode=this.options.enableDebugMode??w.debugMode,this.indexProviders=[Lr("id",this.idIndex),...this.options.indices||[]],this.rebuildIndices(),this.isPullingSignal=Rr(this.options.reactivity,!!(r!=null&&r.persistence)),this.isPushingSignal=Rr(this.options.reactivity,!1),this.on("persistence.pullStarted",()=>{this.isPullingSignal.set(!0)}),this.on("persistence.pullCompleted",()=>{this.isPullingSignal.set(!1)}),this.on("persistence.pushStarted",()=>{this.isPushingSignal.set(!0)}),this.on("persistence.pushCompleted",()=>{this.isPushingSignal.set(!1)}),this.persistenceAdapter=this.options.persistence??null,this.persistenceAdapter){let n=0,s=!1;const i={added:[],modified:[],removed:[]},c=async l=>{if(!this.persistenceAdapter)throw new Error("Persistence adapter not found");this.emit("persistence.pullStarted");const{items:m,changes:f}=l??await this.persistenceAdapter.load();if(m){if(n>0)return;this.memory().splice(0,this.memoryArray().length,...m),this.idIndex.clear(),this.memory().map((h,g)=>{this.idIndex.set(z(h.id),new Set([g]))})}else f&&(f.added.forEach(h=>{const g=this.memory().findIndex(M=>M.id===h.id);if(g!==-1){this.memory().splice(g,1,h);return}this.memory().push(h);const y=this.memory().findIndex(M=>M===h);this.idIndex.set(z(h.id),new Set([y]))}),f.modified.forEach(h=>{const g=this.memory().findIndex(y=>y.id===h.id);if(g===-1)throw new Error("Cannot resolve index for item");this.memory().splice(g,1,h)}),f.removed.forEach(h=>{const g=this.memory().findIndex(y=>y.id===h.id);if(g===-1)throw new Error("Cannot resolve index for item");this.memory().splice(g,1)}));this.rebuildIndices(),this.emit("persistence.received"),setTimeout(()=>this.emit("persistence.pullCompleted"),0)},o={added:[],modified:[],removed:[]};let u=!1;const a=()=>{if(!this.persistenceAdapter)throw new Error("Persistence adapter not found");if(n<=0&&this.emit("persistence.pushStarted"),u||!qr(o))return;u=!0,n+=1;const l=this.memoryArray(),m={...o};o.added=[],o.modified=[],o.removed=[],this.persistenceAdapter.save(l,m).then(()=>{this.emit("persistence.transmitted")}).catch(f=>{this.emit("persistence.error",f instanceof Error?f:new Error(f))}).finally(()=>{n-=1,u=!1,a(),n<=0&&this.emit("persistence.pushCompleted")})};this.on("added",l=>{if(!s){i.added.push(l);return}o.added.push(l),a()}),this.on("changed",l=>{if(!s){i.modified.push(l);return}o.modified.push(l),a()}),this.on("removed",l=>{if(!s){i.removed.push(l);return}o.removed.push(l),a()}),this.persistenceAdapter.register(l=>c(l)).then(async()=>{if(!this.persistenceAdapter)throw new Error("Persistence adapter not found");let l=this.memoryArray();for(await c();qr(i);){const m=i.added.splice(0),f=i.modified.splice(0),h=i.removed.splice(0);l=Ws(this.memoryArray(),{added:m,modified:f,removed:h}),await this.persistenceAdapter.save(l,{added:m,modified:f,removed:h}).then(()=>{this.emit("persistence.transmitted")})}await c(),s=!0,setTimeout(()=>this.emit("persistence.init"),0)}).catch(l=>{this.emit("persistence.error",l instanceof Error?l:new Error(l))})}this.persistenceReadyPromise=new Promise((n,s)=>{if(!this.persistenceAdapter)return n();this.once("persistence.init",n),this.once("persistence.error",s)}),w.onCreationCallbacks.forEach(n=>n(this))}static getCollections(){return w.collections}static onCreation(r){w.onCreationCallbacks.push(r)}static onDispose(r){w.onDisposeCallbacks.push(r)}static batch(r){w.batchOperationInProgress=!0,w.collections.reduce((n,s)=>()=>s.batch(()=>n()),r)(),w.batchOperationInProgress=!1}isPulling(){return this.isPullingSignal.get()??!1}isPushing(){return this.isPushingSignal.get()??!1}isLoading(){const r=this.isPulling(),n=this.isPushing();return r||n}getDebugMode(){return this.debugMode}setDebugMode(r){this.debugMode=r}setFieldTracking(r){this.fieldTracking=r}async isReady(){return this.persistenceReadyPromise}profile(r,n){if(!this.debugMode)return r();const s=performance.now(),i=r(),c=performance.now();return n(c-s),i}executeInDebugMode(r){if(!this.debugMode)return;const n=new Error().stack||"";r(n)}rebuildIndices(){this.indicesOutdated=!0,!this.batchOperationInProgress&&this.rebuildAllIndices()}rebuildAllIndices(){this.idIndex.clear(),this.memory().map((r,n)=>{this.idIndex.set(z(r.id),new Set([n]))}),this.indexProviders.forEach(r=>r.rebuild(this.memoryArray())),this.indicesOutdated=!1}getIndexInfo(r){return r!=null&&Object.keys(r).length===1&&"id"in r&&typeof r.id!="object"?{matched:!0,positions:[...this.idIndex.get(z(r.id))||[]],optimizedSelector:{}}:r==null?{matched:!1,positions:[],optimizedSelector:{}}:this.indicesOutdated?{matched:!1,positions:[],optimizedSelector:r}:Mt(this.indexProviders,r)}getItemAndIndex(r){const n=this.memoryArray(),s=this.getIndexInfo(r),c=(s.matched?s.positions.map(a=>n[a]):n).find(a=>Pr(a,r)),u=s.matched&&s.positions.find(a=>n[a]===c)||n.findIndex(a=>a===c);if(c==null)return{item:null,index:-1};if(u===-1)throw new Error("Cannot resolve index for item");return{item:c,index:u}}deleteFromIdIndex(r,n){this.idIndex.delete(z(r)),this.batchOperationInProgress&&this.idIndex.forEach(([s],i)=>{s>n&&this.idIndex.set(i,new Set([s-1]))})}memory(){return this.options.memory}memoryArray(){return this.memory().map(r=>r)}transform(r){return this.options.transform?this.options.transform(r):r}getItems(r){return this.profile(()=>{const n=this.getIndexInfo(r),s=o=>n.optimizedSelector==null||Object.keys(n.optimizedSelector).length<=0?!0:Pr(o,n.optimizedSelector);this.emit("getItems",r);const i=this.memoryArray();if(!n.matched)return Te(r,{})?i:i.filter(s);const c=n.positions.map(o=>i[o]);return Te(n.optimizedSelector,{})?c:c.filter(s)},n=>this.executeInDebugMode(s=>this.emit("_debug.getItems",s,r,n)))}async dispose(){var r;(r=this.persistenceAdapter)!=null&&r.unregister&&await this.persistenceAdapter.unregister(),this.persistenceAdapter=null,this.memory().map(()=>this.memory().pop()),this.idIndex.clear(),this.indexProviders=[],this.isDisposed=!0,this.removeAllListeners(),w.collections=w.collections.filter(n=>n!==this),w.onDisposeCallbacks.forEach(n=>n(this))}find(r,n){if(this.isDisposed)throw new Error("Collection is disposed");if(r!==void 0&&(!r||typeof r!="object"))throw new Error("Invalid selector");const s=new On(()=>this.getItems(r),{reactive:this.options.reactivity,fieldTracking:this.fieldTracking,...n,transform:this.transform.bind(this),bindEvents:i=>{const c=()=>{if(this.batchOperationInProgress){this.postBatchCallbacks.add(i);return}i()};return this.addListener("persistence.received",c),this.addListener("added",c),this.addListener("changed",c),this.addListener("removed",c),this.emit("observer.created",r,n),()=>{this.removeListener("persistence.received",c),this.removeListener("added",c),this.removeListener("changed",c),this.removeListener("removed",c),this.emit("observer.disposed",r,n)}}});return this.emit("find",r,n,s),this.executeInDebugMode(i=>this.emit("_debug.find",i,r,n,s)),s}findOne(r,n){if(this.isDisposed)throw new Error("Collection is disposed");const i=this.find(r,{limit:1,...n}).fetch()[0]||void 0;return this.emit("findOne",r,n,i),this.executeInDebugMode(c=>this.emit("_debug.findOne",c,r,n,i)),i}batch(r){this.batchOperationInProgress=!0,r(),this.batchOperationInProgress=!1,this.rebuildAllIndices(),this.postBatchCallbacks.forEach(n=>n()),this.postBatchCallbacks.clear()}insert(r){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid item");const s={id:(this.options.primaryKeyGenerator??Tr)(r),...r};if(this.emit("validate",s),this.idIndex.has(z(s.id)))throw new Error("Item with same id already exists");this.memory().push(s);const i=this.memory().findIndex(c=>c===s);return this.idIndex.set(z(s.id),new Set([i])),this.rebuildIndices(),this.emit("added",s),this.emit("insert",s),this.executeInDebugMode(c=>this.emit("_debug.insert",c,s)),s.id}insertMany(r){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid items");if(r.length===0)return[];const n=[];return this.batch(()=>{r.forEach(s=>{n.push(this.insert(s))})}),n}updateOne(r,n,s){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid selector");if(!n)throw new Error("Invalid modifier");const{$setOnInsert:i,...c}=n,{item:o,index:u}=this.getItemAndIndex(r);if(o==null){if(s!=null&&s.upsert){const a=ft({},{...c,$set:{...i,...c.$set}});if(a.id!=null&&this.getItemAndIndex({id:a.id}).item!=null)throw new Error("Item with same id already exists");this.insert(a)}}else{const a=ft(Ct(o),c);if(o.id!==a.id&&this.getItemAndIndex({id:a.id}).item!=null)throw new Error("Item with same id already exists");this.emit("validate",a),this.memory().splice(u,1,a),this.rebuildIndices(),this.emit("changed",a,c)}return this.emit("updateOne",r,n),this.executeInDebugMode(a=>this.emit("_debug.updateOne",a,r,n)),o==null&&!(s!=null&&s.upsert)?0:1}updateMany(r,n,s){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid selector");if(!n)throw new Error("Invalid modifier");const{$setOnInsert:i,...c}=n,o=this.getItems(r);if(o.length===0&&(s!=null&&s.upsert)){const a=ft({},{...c,$set:{...i,...c.$set}});if(a.id!=null&&this.getItemAndIndex({id:a.id}).item!=null)throw new Error("Item with same id already exists");this.insert(a)}const u=o.map(a=>{const{index:l}=this.getItemAndIndex({id:a.id});if(l===-1)throw new Error(`Cannot resolve index for item with id '${a.id}'`);const m=ft(Ct(a),c);if(a.id!==m.id&&this.getItemAndIndex({id:m.id}).item!=null)throw new Error(`Item with same id '${m.id}' already exists`);return this.emit("validate",m),{item:m,index:l}});return u.forEach(({item:a,index:l})=>{this.memory().splice(l,1,a)}),this.rebuildIndices(),u.forEach(({item:a})=>{this.emit("changed",a,c)}),this.emit("updateMany",r,n),this.executeInDebugMode(a=>this.emit("_debug.updateMany",a,r,n)),u.length===0&&(s!=null&&s.upsert)?1:u.length}replaceOne(r,n,s){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid selector");const{item:i,index:c}=this.getItemAndIndex(r);if(i==null){if(s!=null&&s.upsert){if(n.id!=null&&this.getItemAndIndex({id:n.id}).item!=null)throw new Error("Item with same id already exists");this.insert(n)}}else{if(i.id!==n.id&&this.getItemAndIndex({id:n.id}).item!=null)throw new Error("Item with same id already exists");const o={id:i.id,...n};this.emit("validate",o),this.memory().splice(c,1,o),this.rebuildIndices(),this.emit("changed",o,n)}return this.emit("replaceOne",r,n),this.executeInDebugMode(o=>this.emit("_debug.replaceOne",o,r,n)),i==null&&!(s!=null&&s.upsert)?0:1}removeOne(r){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid selector");const{item:n,index:s}=this.getItemAndIndex(r);return n!=null&&(this.memory().splice(s,1),this.deleteFromIdIndex(n.id,s),this.rebuildIndices(),this.emit("removed",n)),this.emit("removeOne",r),this.executeInDebugMode(i=>this.emit("_debug.removeOne",i,r)),n==null?0:1}removeMany(r){if(this.isDisposed)throw new Error("Collection is disposed");if(!r)throw new Error("Invalid selector");const n=this.getItems(r);return n.forEach(s=>{const i=this.memory().findIndex(c=>c===s);if(i===-1)throw new Error("Cannot resolve index for item");this.memory().splice(i,1),this.deleteFromIdIndex(s.id,i),this.rebuildIndices()}),n.forEach(s=>{this.emit("removed",s)}),this.emit("removeMany",r),this.executeInDebugMode(s=>this.emit("_debug.removeMany",s,r)),n.length}};$(w,"collections",[]),$(w,"debugMode",!1),$(w,"batchOperationInProgress",!1),$(w,"fieldTracking",!1),$(w,"onCreationCallbacks",[]),$(w,"onDisposeCallbacks",[]),$(w,"enableDebugMode",()=>{w.debugMode=!0,w.collections.forEach(r=>{r.setDebugMode(!0)})}),$(w,"setFieldTracking",r=>{w.fieldTracking=r,w.collections.forEach(n=>{n.setFieldTracking(r)})});let _t=w;function Ci(e){return e}function Mi(e){return e}function Fe(e,t){const{prefix:r="signaldb-"}={},n=`${r}${e}`,s="items";function i(){return new Promise((o,u)=>{const a=indexedDB.open(n,1);a.addEventListener("upgradeneeded",()=>{const l=a.result;l.objectStoreNames.contains(s)||l.createObjectStore(s,{keyPath:"id"})}),a.addEventListener("success",()=>o(a.result)),a.addEventListener("error",()=>{var l;return u(new Error(((l=a.error)==null?void 0:l.message)||"Database error"))})})}async function c(){const o=await i();return new Promise((u,a)=>{const l=o.transaction(s,"readonly").objectStore(s).getAll();l.addEventListener("success",()=>u(l.result)),l.addEventListener("error",()=>{var m;return a(new Error(((m=l.error)==null?void 0:m.message)||"Error fetching items"))})})}return{async load(){return{items:await c()}},async save(o,{added:u,modified:a,removed:l}){const m=(await i()).transaction(s,"readwrite"),f=m.objectStore(s);return u.forEach(h=>f.add(h)),a.forEach(h=>f.put(h)),l.forEach(h=>f.delete(h.id)),new Promise((h,g)=>{m.addEventListener("complete",()=>h()),m.addEventListener("error",()=>{var y;return g(new Error(((y=m.error)==null?void 0:y.message)||"Transaction error"))})})},async register(){}}}const ie=Symbol(0);let dt=!1,Z=null,Ie=null,F=null,R=0,ve=[],Pt={};const Gs=()=>{},Ae=0,zr=1,ht=2,mt=3;function Vs(){dt=!0,queueMicrotask(Bs)}function Bs(){if(!ve.length){dt=!1;return}for(let e=0;e<ve.length;e++)ve[e].$st!==Ae&&Hs(ve[e]);ve=[],dt=!1}function Hs(e){let t=[e];for(;e=e[ie];)e.$e&&e.$st!==Ae&&t.push(e);for(let r=t.length-1;r>=0;r--)Rt(t[r])}function Qs(e){return Fr(Z,e,null)}function Ys(){return Z}function Js(e){if(!e||!Z)return e||Gs;const t=Z;return t.$d?Array.isArray(t.$d)?t.$d.push(e):t.$d=[t.$d,e]:t.$d=e,function(){t.$st!==mt&&(e.call(null),Hr(t.$d)?t.$d=null:Array.isArray(t.$d)&&t.$d.splice(t.$d.indexOf(e),1))}}function pt(e=!0){if(this.$st!==mt){if(this.$h)if(Array.isArray(this.$h))for(let t=this.$h.length-1;t>=0;t--)pt.call(this.$h[t]);else pt.call(this.$h);if(e){const t=this[ie];t&&(Array.isArray(t.$h)?t.$h.splice(t.$h.indexOf(this),1):t.$h=null),Xs(this)}}}function Xs(e){e.$st=mt,e.$d&&Ur(e),e.$s&&Dt(e,0),e[ie]=null,e.$s=null,e.$o=null,e.$h=null,e.$cx=Pt,e.$eh=null}function Ur(e){try{if(Array.isArray(e.$d))for(let t=e.$d.length-1;t>=0;t--){const r=e.$d[t];r.call(r)}else e.$d.call(e.$d);e.$d=null}catch(t){Kr(e,t)}}function Fr(e,t,r){const n=Z,s=Ie;Z=e,Ie=r;try{return t.call(e)}finally{Z=n,Ie=s}}function Kr(e,t){if(!e||!e.$eh)throw t;let r=0,n=e.$eh.length,s=t;for(r=0;r<n;r++)try{e.$eh[r](s);break}catch(i){s=i}if(r===n)throw s}function Wr(){return this.$st===mt?this.$v:(Ie&&!this.$e&&(!F&&Ie.$s&&Ie.$s[R]==this?R++:F?F.push(this):F=[this]),this.$c&&Rt(this),this.$v)}function Gr(e){const t=Hr(e)?e(this.$v):e;if(this.$ch(this.$v,t)&&(this.$v=t,this.$o))for(let r=0;r<this.$o.length;r++)Yr(this.$o[r],ht);return this.$v}const Vr=function(){this[ie]=null,this.$h=null,Z&&Z.append(this)},fe=Vr.prototype;fe.$cx=Pt,fe.$eh=null,fe.$c=null,fe.$d=null,fe.append=function(e){e[ie]=this,this.$h?Array.isArray(this.$h)?this.$h.push(e):this.$h=[this.$h,e]:this.$h=e,e.$cx=e.$cx===Pt?this.$cx:{...this.$cx,...e.$cx},this.$eh&&(e.$eh=e.$eh?[...e.$eh,...this.$eh]:this.$eh)},fe.dispose=function(){pt.call(this)};const Br=function(t,r,n){Vr.call(this),this.$st=r?ht:Ae,this.$i=!1,this.$e=!1,this.$s=null,this.$o=null,this.$v=t,r&&(this.$c=r),n&&n.dirty&&(this.$ch=n.dirty)},Tt=Br.prototype;Object.setPrototypeOf(Tt,fe),Tt.$ch=ei,Tt.call=Wr;function Zs(e,t,r){return new Br(e,t,r)}function ei(e,t){return e!==t}function Hr(e){return typeof e=="function"}function Rt(e){if(e.$st===zr)for(let t=0;t<e.$s.length&&(Rt(e.$s[t]),e.$st!==ht);t++);e.$st===ht?ri(e):e.$st=Ae}function ti(e){e.$h&&pt.call(e,!1),e.$d&&Ur(e),e.$eh=e[ie]?e[ie].$eh:null}function ri(e){let t=F,r=R;F=null,R=0;try{ti(e);const n=Fr(e,e.$c,e);Qr(e),!e.$e&&e.$i?Gr.call(e,n):(e.$v=n,e.$i=!0)}catch(n){Qr(e),Kr(e,n)}finally{F=t,R=r,e.$st=Ae}}function Qr(e){if(F){if(e.$s&&Dt(e,R),e.$s&&R>0){e.$s.length=R+F.length;for(let r=0;r<F.length;r++)e.$s[R+r]=F[r]}else e.$s=F;let t;for(let r=R;r<e.$s.length;r++)t=e.$s[r],t.$o?t.$o.push(e):t.$o=[e]}else e.$s&&R<e.$s.length&&(Dt(e,R),e.$s.length=R)}function Yr(e,t){if(!(e.$st>=t)&&(e.$e&&e.$st===Ae&&(ve.push(e),dt||Vs()),e.$st=t,e.$o))for(let r=0;r<e.$o.length;r++)Yr(e.$o[r],zr)}function Dt(e,t){let r,n;for(let s=t;s<e.$s.length;s++)r=e.$s[s],r.$o&&(n=r.$o.indexOf(e),r.$o[n]=r.$o[r.$o.length-1],r.$o.pop())}function ni(e,t){const r=Zs(e,null,t),n=Wr.bind(r);return n[ie]=!0,n.set=Gr.bind(r),n}const Ke={create:()=>{const e=ni(0);return{depend:()=>{e()},notify:()=>{e.set(Qs(()=>e()+1))}}},isInScope:()=>!!Ys(),onDispose:e=>Js(e)};class We extends _t{upsertMany(t){this.batch(()=>{for(const r of t)this.updateOne({id:r.id},{$set:r},{upsert:!0})})}}const ke=new We({persistence:Fe("subjects"),reactivity:Ke,indices:[U("id"),U("object"),U("level")]}),je=new We({persistence:Fe("assignments"),reactivity:Ke,indices:[U("id"),U("subject_id"),U("srs_stage"),U("available_at")]}),Jr=new We({persistence:Fe("study_materials"),reactivity:Ke,indices:[U("id"),U("subject_id")]}),Xr=new We({persistence:Fe("users"),reactivity:Ke});new We({persistence:Fe("logs"),reactivity:Ke,indices:[U("id"),U("timestamp"),U("level")]});var gt=(e=>(e.HIRAGANA="hiragana",e.KATAKANA="katakana",e.RADICAL="radical",e.KANJI="kanji",e.VOCABULARY="vocabulary",e))(gt||{});function Zr(e){let t=e.object;return!t&&e.document_url&&(e.document_url.startsWith("https://www.wanikani.com/radicals")?t=gt.RADICAL:e.document_url.startsWith("https://www.wanikani.com/kanji")?t=gt.KANJI:e.document_url.startsWith("https://www.wanikani.com/vocabulary")?t=gt.VOCABULARY:console.error("missing object for subject: ",e)),{...e,object:t}}async function Nt(e,t){let r=await e();for(r.data.length>0&&await t(r.data.map(n=>({...n.data,id:n.id})));r.pages.next_url&&r.data.length>0;)console.log("[Sync] Fetching next page..."),r=await ge.request(r.pages.next_url),r.data.length>0&&await t(r.data.map(n=>({...n.data,object:n.object,url:n.url,id:n.id})))}function si(e){ge.setToken(e)}async function ii(){const e=await ge.getUser();Xr.updateOne({id:"current"},{$set:{...e.data,id:"current"}})}async function oi(){const e=ke.find({object:{$eq:void 0}}).fetch();console.log("migrating %s subjects",e.length),ke.batch(()=>{e.forEach(t=>{const r=Zr(t);ke.updateOne({id:t.id},{$set:r})})}),console.log("migration complete, %s broken subjects left",ke.find({object:{$eq:void 0}}).count())}async function ci(e){await Nt(()=>ge.getSubjectsUpdatedAfter(e||void 0),async t=>{ke.upsertMany(t.map(Zr)),console.log("inserted or updated: %s items",t.length)})}async function ai(){const e=je.find({srs_stage:-1}).fetch();console.log("migrating %s assignments",e.length),je.batch(()=>{e.forEach(t=>{je.updateOne({id:t.id},{$set:{...t,srs_stage:1}})})}),console.log("migration complete, %s broken assignments left",je.find({srs_stage:-1}).count())}async function ui(e){await Nt(()=>ge.getAssignmentsUpdatedAfter(e||void 0),async t=>{je.upsertMany(t),console.log("inserted or updated: %s items",t.length)})}async function li(e){await Nt(()=>ge.getStudyMaterialsUpdatedAfter(e||void 0),async t=>{Jr.upsertMany(t),console.log("inserted or updated: %s items",t.length)})}async function fi(){ke.removeMany({}),je.removeMany({}),Jr.removeMany({}),Xr.removeMany({})}var di=Object.freeze({__proto__:null,clearData:fi,migrateAssignments:ai,migrateSubjects:oi,setToken:si,syncAssignments:ui,syncStudyMaterials:li,syncSubjects:ci,syncUser:ii});yt(di)})();
